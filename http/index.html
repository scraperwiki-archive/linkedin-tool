<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LinkedIn creeper tool</title>
    <meta http-equiv="cleartype" content="on">
    <link rel="stylesheet" href="vendor/css/bootstrap.min.css">
    <link rel="stylesheet" href="//x.scraperwiki.com/style/scraperwiki.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>

    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="vendor/js/bootstrap.min.js"></script>
    <script src="vendor/js/jquery-io.js"></script>
    <script src="http://coffeescript.org/extras/coffee-script.js"></script>
  </head>
  <body>
     <form>
         <p>
           <textarea></textarea>
         </p>
         <p>
           <button class="btn btn-primary" type="button" id="authenticate">Import</button>
         </p>
     </form>
    <div>
    </div>
    <script type="text/coffeescript">

requestAccessToken = ->
  grant_type: authorization_code

getClientIdAndSecret = (callback) ->
  scraperwiki.exec('cat ~/tool/oauth_keys.json').success (data) ->
    keys = JSON.parse data
    callback null, {id: keys.apiKey, secret: keys.secretKey}

populateTextArea = ->
  scraperwiki.sql("select name from source").success (data) ->
    list = (p.name for p in data)
    text = list.join('\n')
    $('textarea').val(text)

$ ->
  populateTextArea()
  importNames = (callback) ->
    scraperwiki.exec("cat 2>/dev/null access_token.json").success (data) ->
      if not data.length
        # Don't have access_tokens yet, so start the process
        # of getting them.
        getClientIdAndSecret (err, keys) ->
          scraperwiki.tool.getURL (url) ->
            params =
              response_type: 'code'
              client_id: keys.id
              scope: 'r_network'
              state: 'abc'
              redirect_uri: url
            qs = $.io.object(params).query()
            target = "https://www.linkedin.com/uas/oauth2/authorization?#{qs}"
            scraperwiki.tool.redirect target
      else
        alertAuthenticated()
        runSeeker()

  $('#authenticate').on 'click', ->
    $(@).addClass('loading').text('Importing')
    importNames()
    escapedNames = scraperwiki.shellEscape $('textarea').val()
    scraperwiki.exec("echo #{escapedNames} | python tool/code/namestodb.py")

  scraperwiki.tool.getURL (url) ->
    qs = url.match(/[?](.*)/)
    if qs?
      # Redirected from LinkedIn
      qs = qs[1]
      console.log "GOT QS #{qs}"
      params = $.io.query(qs).object()
      if params.code and params.state
        getClientIdAndSecret (err, keys) ->
          console.log "GOT CODE #{qs}"
          # LinkedIn have redirected back here.
          redirect_url = url.match(/(.*?)[?]/)[1]
          access_params =
            grant_type: 'authorization_code'
            code: params.code
            redirect_uri: redirect_url
            client_id: keys.id
            client_secret: keys.secret
          access_qs = $.io.object(access_params).query()
          target = "https://api.linkedin.com/uas/oauth2/accessToken?#{access_qs}"
          scraperwiki.exec "curl #{scraperwiki.shellEscape(target)} > access_token.json", ->
            alertAuthenticated()
            runSeeker()
            # TODO: cron job, show loading button
      else if params.error and params.state
        console.log "GOT ERROR #{qs}"
        # Some sort of error (from LinkedIn).
        scraperwiki.alert params.error, params.description, true
      else
        scraperwiki.alert "Mysterious params", "WAT?", true
    else
      console.log "GOT no query parameters"
      # No query params, so we haven't been redirected here.
      # Must be viewing the tool settings, possibly having
      # just been installed.

runSeeker = ->
  scraperwiki.exec "tool/code/seeker.py --limit 100"

alertAuthenticated = ->
  scraperwiki.alert "Authenticated", "Able to read data from LinkedIn"
        </script>

      </body>
</html>
