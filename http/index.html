<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LinkedIn creeper tool</title>
    <meta http-equiv="cleartype" content="on">
    <link rel="stylesheet" href="vendor/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendor/css/scraperstrap.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>

    <script src="https://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="vendor/js/bootstrap.min.js"></script>
    <script src="vendor/js/jquery-io.js"></script>
    <script src="http://coffeescript.org/extras/coffee-script.js"></script>
  </head>
  <body>
     <div class="settings" id="settings-auth" display="none">
         <p>To import your data, please
         <button class="btn btn-primary" type="button" id="authenticate">Authenticate</button> with LinkedIn.
    </div>
    <div>
    </div>
    <script type="text/coffeescript">

requestAccessToken = ->
  grant_type: authorization_code
$ ->
  # cat oauth_keys from box
  scraperwiki.exec('cat ~/tool/oauth_keys.json').success (data) ->
    keys = JSON.parse data
    client_id = keys.apiKey
    client_secret = keys.secretKey
    scraperwiki.tool.getURL (url) ->
      qs = url.match(/[?](.*)/)
      if qs?
        qs = qs[1]
        console.log "GOT QS #{qs}"
        params = $.io.query(qs).object()
        if params.code and params.state
          console.log "GOT CODE #{qs}"
          # LinkedIn have redirected back here.
          redirect_url = url.match(/(.*?)[?]/)[1]
          access_params =
            grant_type: 'authorization_code'
            code: params.code
            redirect_uri: redirect_url
            client_id: client_id
            client_secret: client_secret
          access_qs = $.io.object(access_params).query()
          target = "https://api.linkedin.com/uas/oauth2/accessToken?#{access_qs}"
          scraperwiki.exec "curl #{scraperwiki.shellEscape(target)} > access_token.json", (data) ->
            alertAuthenticated()
        else if params.error and params.state
          console.log "GOT ERROR #{qs}"
          # Some sort of error (from LinkedIn).
          scraperwiki.alert params.error, params.description, true
        else
          scraperwiki.alert "Mysterious params", "WAT?", true
      else
        console.log "GOT no query parameters"
        # No query params, so we haven't been redirected here.
        # Must be viewing the tool settings, possibly having
        # just been installed.
        scraperwiki.exec("cat 2>/dev/null access_token.json").success (data) ->
          if not data.length
            $('#settings-auth').show()
            # Don't have access_tokens yet, so start the process
            # of getting them.
            params =
              response_type: 'code'
              client_id: client_id
              scope: 'r_network'
              state: 'abc'
              redirect_uri: url
            qs = $.io.object(params).query()
            $('#authenticate').on 'click', ->
              target = "https://www.linkedin.com/uas/oauth2/authorization?#{qs}"
              scraperwiki.tool.redirect target
          else
            alertAuthenticated()

alertAuthenticated = ->
  $('#settings-auth').hide()
  scraperwiki.alert "Authenticated", "Reading data from LinkedIn"
        </script>

      </body>
</html>
